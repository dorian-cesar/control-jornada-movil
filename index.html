<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control en ruta</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Control en ruta</h1>
        <div class="btn-container">
            <input oninput="this.value = this.value.toUpperCase()" class="input-patente" type="text" name="patente" id="selveh" placeholder="Ingrese patente"/>
            <button onclick="loadData()" class="btn-half">Cargar datos</button>
        </div>
        <div id="card-container" class="log-container">
            <hr>
            <b style="font-weight: 800;"><p id="log-nombre" class="print-left"> </p><p id="log-patente" class="print-right"> </p></b>
            <p id="log-rut" class="print-left"> </p><p id="log-fecha" class="print-right"> </p>
            <p id="log-nfchour"> </p>
            <p id="log-nfc"> </p>
            <p id="log-status"> </p>
            <span id="log-content" class="eventos">
            </span>
        </div>
        <button onclick="printRawBT()" class="btn-confirm">Imprimir</button>
        
        <div id="loadScreen" class="modal-bg">
            <span>
                <h1></h1>
                <h3>Cargando</h3>
            </span>
        </div>
        
    </div>
    <script src="common.js"></script>
    <script>
        var cardText = document.getElementById("card-container");
        var nombre = document.getElementById("log-nombre");
        var patente = document.getElementById("log-patente");
        var rut = document.getElementById("log-rut");
        var fecha = document.getElementById("log-fecha");
        var logcontent = document.getElementById("log-content");
        var logstatus = document.getElementById("log-status");
        var nfc = document.getElementById("log-nfc");
        var nfchour = document.getElementById("log-nfchour");
        var vehsel = document.getElementById("selveh");
        var loadScreen = document.getElementById("loadScreen");

        var dataArr = null;

        //loadData();

        // Imprime todos los datos en el POS
        async function printRawBT(){
            if(dataArr){
                var btext = divider;
                btext += toColumn(nombre.textContent,patente.textContent);
                btext += toColumn(rut.textContent,fecha.textContent);
                btext += toLeft(nfchour.textContent);
                btext += toLeft(nfc.textContent);
                btext += toLeft(logstatus.textContent);
                // Para los ultimos 5 registros
                for(let i = 0;i<5;i++){
                    if(dataArr[i]){
                        btext += divider;
                        let horaStr = dataArr[i].date.v.split(" ")[1]; //To-Do remover split
                        let speedStr = dataArr[i].speed.v+"Km/h";
                        let latStr = dataArr[i].lat.v;
                        let lngStr = dataArr[i].lng.v;
                        btext += toColumn(horaStr,speedStr);
                        btext += toColumn(latStr,lngStr);
                    }
                }
                btext = toBT(btext);
                // Imprimir a traves de RawBT
                window.location.href = btext;
            } else {
                window.alert("Nada que imprimir");
                return;
                /*var btext = divider; // Datos falsos
                btext += toColumn(nombre.textContent,patente.textContent);
                btext += toColumn(rut.textContent,fecha.textContent);
                btext += toLeft(logstatus.textContent);

                    btext += divider;
                    btext += toColumn("11:30:52","42Km/h");
                    btext += toColumn("-33.405297","-70.539448");

                    btext += divider;
                    btext += toColumn("11:30:40","35Km/h");
                    btext += toColumn("-33.405542","-70.540527");

                    btext += divider;
                    btext += toColumn("11:30:31","38Km/h");
                    btext += toColumn("-33.405785","-70.541643");

                    btext += divider;
                    btext += toColumn("11:30:23","40Km/h");
                    btext += toColumn("-33.406015","-70.542745");

                    btext += divider;
                    btext += toColumn("11:30:15","43Km/h");
                    btext += toColumn("-33.406387","-70.543847");

                btext = toBT(btext);
                console.log(btext);
                window.location.href = btext;*/
            }
        }
        async function loadData(){
            // Validar que vehpat tenga algo escrito
            let vehpat = vehsel.value;
            if(!vehpat){
                vehsel.focus();
                return;
            }
            // Habilitamos la pantalla de carga
            loadScreen.style.display = "block";
            let data = await fetch("https://dev.wit.la/api/gpshist/"+vehpat)
            .then(response => response.json())
            .then(data => {
                // Si no hay datos
                if(data.success==false||!data.report.sheets[0].sections[0].data){
                    //Desactivado temporalmente
                    //window.alert("No hay registros!");
                    logcontent.textContent = "";
                    nombre.textContent = "Sin registros";
                    patente.textContent = "";
                    rut.textContent = "";
                    fecha.textContent = "";
                    logstatus.textContent = "";
                    loadScreen.style.display = "none";
                    return;
                }
                // Desactivamos la pantalla de carga
                loadScreen.style.display = "none";
                const logs = data.report.sheets[0].sections[0].data[0].rows;

                // Creamos un array con los datos en direccion inversa
                dataArr = logs.reverse();

                var condNFC = null;
                var condNFCHour = null;

                // Si tenemos un conductor, imprimir su nombre y rut
                if(data.driver){
                    console.log(data.driver);
                    // Apellido
                    let nombreCond = data.driver.current.last_name;
                    // Primer Nombre
                    nombreCond += " " + data.driver.current.first_name;
                    // Segundo Nombre (Opcional)
                    if(data.driver.current.middle_name) {
                        nombreCond += " " + data.driver.current.middle_name.substring(0,1) + ".";
                    }
                    if(nombreCond.length>14){
                        nombreCond = nombreCond.substring(0,14);
                    }
                    nombre.textContent = nombreCond;
                    rut.textContent = data.driver.current.personnel_number;
                    condNFC = data.driver.current.hardware_key;
                    condNFCHour = data.driver.last_change.changed.split(" ")[1];
                } else { // De lo contrario
                    nombre.textContent = "Sin datos";
                    rut.textContent = "Sin datos";
                }

                // datos básicos
                patente.textContent = data.report.sheets[0].header;
                fecha.textContent = data.report.created.split(" ")[0];
                logstatus.textContent = dataArr[0].status.v;
                nfchour.textContent = "Últ. Conexión: " + condNFCHour;

                if(condNFC) {
                    nfc.textContent = "Tarjeta: " + condNFC;
                }

                // Limpiamos el contenido del preview
                logcontent.textContent = "";

                dataArr.forEach(item => {
                    // Creamos elementos
                    var logHR = document.createElement("hr");
                    var logHour = document.createElement("p");
                    var logSpeed = document.createElement("p");
                    var logLat = document.createElement("p");
                    var logLng = document.createElement("p");

                    // Asignamos valores
                    logHour.textContent = item.date.v.split(" ")[1];
                    logSpeed.textContent = item.speed.v+"Km/h";
                    logLat.textContent = item.lat.v;
                    logLng.textContent = item.lng.v;

                    // Asignamos clases
                    logHour.classList.add("print-left");
                    logLat.classList.add("print-left");

                    logSpeed.classList.add("print-right");
                    logLng.classList.add("print-right");

                    // Insertamos en el arbol de html
                    logcontent.appendChild(logHR);
                    logcontent.appendChild(logHour);
                    logcontent.appendChild(logSpeed);
                    logcontent.appendChild(logLat);
                    logcontent.appendChild(logLng);
                    logcontent.appendChild(logLng);
                });
            })
            .catch(error => {
                loadScreen.style.display = "none";
                console.error(error);
            });
        }
    </script>
</body>
</html>